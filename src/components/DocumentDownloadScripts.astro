---
const { cdnUrl = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js' } = Astro.props;
---

<script is:inline define:vars={{ cdnUrl }}>
  (() => {
    if (window.__docPdfInit) return;
    window.__docPdfInit = true;

    const loadHtml2Pdf = () => new Promise((resolve, reject) => {
      if (window.html2pdf) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = cdnUrl;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Failed to load html2pdf.js'));
      document.head.appendChild(script);
    });

    const handleDownload = async (event) => {
      const button = event.target.closest('[data-doc-download]');
      if (!button) return;
      event.preventDefault();
      event.stopPropagation();

      const docId = button.getAttribute('data-doc-id');
      const filename = button.getAttribute('data-doc-filename') || 'document.pdf';
      const target = docId ? document.getElementById(docId) : null;

      if (!target) {
        console.error('Target element not found:', docId);
        return;
      }

      const previousStyles = target
        ? {
            maxHeight: target.style.maxHeight,
            overflow: target.style.overflow,
            height: target.style.height,
            width: target.style.width,
            padding: target.style.padding,
            boxSizing: target.style.boxSizing,
          }
        : null;

      let allElements = [];
      let elementOriginalStyles = [];

      try {
        if (target) {
          // PDF生成用のスタイルを適用
          target.style.maxHeight = 'none';
          target.style.overflow = 'visible';
          target.style.height = 'auto';
          target.style.width = '210mm'; // A4幅
          target.style.padding = '10mm';
          target.style.boxSizing = 'border-box';
          
          // すべての子要素の幅も調整
          allElements = Array.from(target.querySelectorAll('*'));
          elementOriginalStyles = allElements.map(el => {
            const original = {
              element: el,
              maxWidth: el.style.maxWidth,
              wordWrap: el.style.wordWrap,
              overflowWrap: el.style.overflowWrap,
            };
            // テキストが切れないように幅を調整
            if (el.tagName === 'P' || el.tagName === 'DIV' || el.tagName === 'SPAN' || el.tagName === 'TD' || el.tagName === 'TH') {
              el.style.maxWidth = '100%';
              el.style.wordWrap = 'break-word';
              el.style.overflowWrap = 'break-word';
            }
            return original;
          });
          
          await loadHtml2Pdf();
          if (!window.html2pdf) {
            console.error('html2pdf is not loaded');
            return;
          }
          
          const options = {
            margin: [5, 5, 5, 5],
            filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
              scale: 2, 
              useCORS: true, 
              allowTaint: true, 
              backgroundColor: '#ffffff',
              width: 794, // A4幅をピクセルに変換 (210mm * 3.78)
              windowWidth: 794,
              logging: false
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['css', 'legacy'], avoid: ['tr', 'td', 'th'] },
          };
          
          await window.html2pdf().set(options).from(target).save();
        }
      } catch (error) {
        console.error('PDF generation error:', error);
      } finally {
        if (target && previousStyles) {
          target.style.maxHeight = previousStyles.maxHeight;
          target.style.overflow = previousStyles.overflow;
          target.style.height = previousStyles.height;
          target.style.width = previousStyles.width;
          target.style.padding = previousStyles.padding;
          target.style.boxSizing = previousStyles.boxSizing;
        }
        // 子要素のスタイルも元に戻す
        elementOriginalStyles.forEach(({ element, maxWidth, wordWrap, overflowWrap }) => {
          element.style.maxWidth = maxWidth;
          element.style.wordWrap = wordWrap;
          element.style.overflowWrap = overflowWrap;
        });
      }
    };

    document.addEventListener('click', handleDownload);
  })();
</script>
