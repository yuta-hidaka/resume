---
const { cdnUrl = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js' } = Astro.props;
---

<script is:inline define:vars={{ cdnUrl }}>
  (() => {
    if (window.__docPdfInit) return;
    window.__docPdfInit = true;

    const loadHtml2Pdf = () => new Promise((resolve, reject) => {
      if (window.html2pdf) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = cdnUrl;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Failed to load html2pdf.js'));
      document.head.appendChild(script);
    });

    const waitForFonts = () => {
      if (document.fonts && document.fonts.ready) {
        return document.fonts.ready;
      }
      return Promise.resolve();
    };

    const waitForImages = (root) => {
      const images = Array.from(root.querySelectorAll('img'));
      if (!images.length) return Promise.resolve();
      return Promise.all(
        images.map((img) => {
          if (img.complete) return Promise.resolve();
          return new Promise((resolve) => {
            const done = () => resolve();
            img.addEventListener('load', done, { once: true });
            img.addEventListener('error', done, { once: true });
          });
        })
      );
    };

    const handleDownload = async (event) => {
      const button = event.target.closest('[data-doc-download]');
      if (!button) return;
      event.preventDefault();
      event.stopPropagation();

      const docId = button.getAttribute('data-doc-id');
      const filename = button.getAttribute('data-doc-filename') || 'document.pdf';
      const target = docId ? document.getElementById(docId) : null;

      if (!target) {
        console.error('Target element not found:', docId);
        return;
      }

      const previousStyles = target
        ? {
            maxHeight: target.style.maxHeight,
            overflow: target.style.overflow,
            height: target.style.height,
            width: target.style.width,
            padding: target.style.padding,
            boxSizing: target.style.boxSizing,
          }
        : null;
      const pdfClass = 'doc-viewer--pdf';
      const hadPdfClass = target.classList.contains(pdfClass);

      try {
        if (target) {
          // PDF生成用のスタイルを適用
          target.classList.add(pdfClass);
          target.style.maxHeight = 'none';
          target.style.overflow = 'visible';
          target.style.height = 'auto';
          target.style.width = '210mm'; // A4幅
          target.style.padding = '0';
          target.style.boxSizing = 'border-box';

          await Promise.all([waitForFonts(), waitForImages(target)]);
          await new Promise((resolve) => requestAnimationFrame(resolve));

          await loadHtml2Pdf();
          if (!window.html2pdf) {
            console.error('html2pdf is not loaded');
            return;
          }

          const pdfWidth = Math.ceil(target.getBoundingClientRect().width);
          const options = {
            margin: 0,
            filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: '#ffffff',
              width: pdfWidth,
              windowWidth: pdfWidth,
              logging: false,
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['css', 'legacy'] },
          };
          
          await window.html2pdf().set(options).from(target).save();
        }
      } catch (error) {
        console.error('PDF generation error:', error);
      } finally {
        if (target && previousStyles) {
          target.style.maxHeight = previousStyles.maxHeight;
          target.style.overflow = previousStyles.overflow;
          target.style.height = previousStyles.height;
          target.style.width = previousStyles.width;
          target.style.padding = previousStyles.padding;
          target.style.boxSizing = previousStyles.boxSizing;
        }
        if (target && !hadPdfClass) {
          target.classList.remove(pdfClass);
        }
      }
    };

    document.addEventListener('click', handleDownload);
  })();
</script>
