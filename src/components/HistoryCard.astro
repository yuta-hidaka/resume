---
interface Props {
  company: string;
  startDate: string;
  endDate: string;
  jobTitle: string;
  job: string;
  jobDescription: string;
  tags?: string[];
  index: number;
  locale: string;
}

const { company, startDate, endDate, jobTitle, job, jobDescription, tags, index, locale } = Astro.props;

function formatDate(dateStr: string, locale: string): string {
  if (!dateStr) return locale === 'ja' ? '現在' : 'Present';
  const date = new Date(dateStr);
  if (locale === 'en') {
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
  }
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
}

const formattedStartDate = formatDate(startDate, locale);
const formattedEndDate = formatDate(endDate, locale);
const isOngoing = !endDate;
---

<article class="career-card group relative pl-8 pb-8 last:pb-0">
  <!-- Timeline Line -->
  <div class="absolute left-0 top-0 bottom-0 w-px bg-[var(--glass-border)] group-last:bg-gradient-to-b group-last:from-[var(--glass-border)] group-last:to-transparent"></div>
  
  <!-- Timeline Dot -->
  <div class:list={[
    'absolute left-0 top-2 w-3 h-3 rounded-full -translate-x-1/2 border-2 transition-all duration-300',
    isOngoing 
      ? 'bg-[var(--accent)] border-[var(--accent)] animate-pulse' 
      : 'bg-[var(--bg-primary)] border-[var(--glass-border)] group-hover:border-[var(--accent)] group-hover:bg-[var(--accent)]'
  ]}></div>
  
  <!-- Card Content -->
  <div class="glass-card p-6 ml-4 cursor-pointer" data-expandable>
    <!-- Header -->
    <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
      <div>
        <h3 class="text-xl font-semibold text-[var(--text-primary)] group-hover:text-[var(--accent)] transition-colors">
          {company}
        </h3>
        <p class="text-[var(--accent)] font-medium mt-1">{jobTitle}</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-[var(--text-muted)] font-mono">
        <span>{formattedStartDate}</span>
        <span>→</span>
        <span class:list={[isOngoing && 'text-[var(--accent)]']}>{formattedEndDate}</span>
      </div>
    </div>
    
    <!-- Job Type -->
    <p class="text-[var(--text-secondary)] font-medium mb-3">{job}</p>
    
    <!-- Description -->
    <p class="job-description text-[var(--text-muted)] leading-relaxed line-clamp-2 transition-all duration-300">
      {jobDescription}
    </p>
    
    <!-- Expand Indicator -->
    <div class="expand-indicator mt-3 text-xs text-[var(--accent)] opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
      <span>Click to expand</span>
      <span class="expand-arrow transition-transform">↓</span>
    </div>
  </div>
</article>

<script>
  document.querySelectorAll('[data-expandable]').forEach((card) => {
    let expanded = false;
    const description = card.querySelector('.job-description');
    const arrow = card.querySelector('.expand-arrow');
    const indicator = card.querySelector('.expand-indicator span:first-child');
    
    card.addEventListener('click', () => {
      expanded = !expanded;
      if (description) {
        if (expanded) {
          description.classList.remove('line-clamp-2');
          if (arrow) arrow.style.transform = 'rotate(180deg)';
          if (indicator) indicator.textContent = 'Click to collapse';
        } else {
          description.classList.add('line-clamp-2');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
          if (indicator) indicator.textContent = 'Click to expand';
        }
      }
    });
  });
</script>
