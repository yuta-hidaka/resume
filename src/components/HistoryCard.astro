---
interface Props {
  company: string;
  startDate: string;
  endDate: string;
  jobTitle: string;
  job: string;
  jobDescription: string;
  tags?: string[];
  index: number;
  locale: string;
  isLast?: boolean;
}

const { company, startDate, endDate, jobTitle, job, jobDescription, tags, index, locale, isLast = false } = Astro.props;

function formatDate(dateStr: string, locale: string): string {
  if (!dateStr) return locale === 'ja' ? '現在' : 'Present';
  const date = new Date(dateStr);
  if (locale === 'en') {
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
  }
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
}

const formattedStartDate = formatDate(startDate, locale);
const formattedEndDate = formatDate(endDate, locale);
const isOngoing = !endDate;
---

<article class="career-card group relative pl-10">
  <!-- Timeline Line -->
  <div class:list={[
    'absolute left-0 top-0 w-0.5 bg-[var(--glass-border)]',
    isLast ? 'bottom-0' : 'bottom-[-2rem]'
  ]}></div>
  
  <!-- Timeline Dot -->
  <div class:list={[
    'absolute left-0 top-3 w-4 h-4 rounded-full -translate-x-1/2 border-2 transition-all duration-500 shadow-lg',
    isOngoing 
      ? 'bg-[var(--accent)] border-[var(--accent)] shadow-[0_0_12px_var(--glow-color)] animate-pulse' 
      : 'bg-[var(--bg-primary)] border-[var(--glass-border)] group-hover:border-[var(--accent)] group-hover:bg-[var(--accent)] group-hover:shadow-[0_0_12px_var(--glow-color)]'
  ]}>
    {isOngoing && (
      <div class="absolute inset-0 rounded-full bg-[var(--accent)] animate-ping opacity-75"></div>
    )}
  </div>
  
  <!-- Card Content -->
  <div class="glass-card p-8 ml-6 cursor-pointer group/card" data-expandable>
    <!-- Header -->
    <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
      <div class="flex-1 min-w-0">
        <h3 class="text-2xl font-bold text-[var(--text-primary)] group-hover/card:text-[var(--accent)] transition-colors duration-300 mb-2">
          {company}
        </h3>
        <p class="text-[var(--accent)] font-semibold text-lg">{jobTitle}</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-[var(--text-muted)] font-mono px-3 py-1.5 rounded-lg bg-[var(--glass-bg)] border border-[var(--glass-border)]">
        <span>{formattedStartDate}</span>
        <span class="text-[var(--accent)]">→</span>
        <span class:list={[isOngoing && 'text-[var(--accent)] font-semibold']}>{formattedEndDate}</span>
      </div>
    </div>
    
    <!-- Job Type -->
    <div class="mb-5">
      <span class="inline-block px-3 py-1.5 text-sm font-semibold text-[var(--accent)] bg-[var(--glass-bg)] border border-[var(--accent)]/30 rounded-lg">
        {job}
      </span>
    </div>
    
    <!-- Description -->
    <div class="job-description text-[var(--text-secondary)] text-base leading-relaxed tracking-tight line-clamp-3 transition-all duration-500">
      {jobDescription}
    </div>
    
    <!-- Expand Indicator -->
    <div class="expand-indicator mt-5 text-sm text-[var(--accent)] opacity-0 group-hover/card:opacity-100 transition-all duration-300 flex items-center gap-2 font-medium">
      <span>Click to expand</span>
      <span class="expand-arrow transition-transform duration-300 text-lg">↓</span>
    </div>
  </div>
</article>

<script>
  document.querySelectorAll('[data-expandable]').forEach((card) => {
    let expanded = false;
    const description = card.querySelector('.job-description');
    const arrow = card.querySelector('.expand-arrow') as HTMLElement | null;
    const indicator = card.querySelector('.expand-indicator span:first-child') as HTMLElement | null;
    
    card.addEventListener('click', () => {
      expanded = !expanded;
      if (description) {
        if (expanded) {
          description.classList.remove('line-clamp-3');
          if (arrow) arrow.style.transform = 'rotate(180deg)';
          if (indicator) indicator.textContent = 'Click to collapse';
        } else {
          description.classList.add('line-clamp-3');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
          if (indicator) indicator.textContent = 'Click to expand';
        }
      }
    });
  });
</script>
