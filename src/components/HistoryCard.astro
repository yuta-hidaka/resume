---
interface Props {
  company: string;
  startDate: string;
  endDate: string;
  jobTitle: string;
  job: string;
  jobDescription: string;
  tags?: string[];
  index: number;
  locale: string;
  isLast?: boolean;
}

const { company, startDate, endDate, jobTitle, job, jobDescription, tags, index, locale, isLast = false } = Astro.props;

function formatDate(dateStr: string, locale: string): string {
  if (!dateStr) return locale === 'ja' ? '現在' : 'Present';
  const date = new Date(dateStr);
  if (locale === 'en') {
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
  }
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
}

const formattedStartDate = formatDate(startDate, locale);
const formattedEndDate = formatDate(endDate, locale);
const isOngoing = !endDate;
---

<article class="career-card group relative pl-10" data-card-index={index}>
  <!-- Timeline Line -->
  <div class:list={[
    'absolute left-0 top-0 w-0.5 bg-[var(--glass-border)]',
    isLast ? 'bottom-0' : 'bottom-[-2rem]'
  ]}></div>
  
  <!-- Timeline Dot -->
  <div 
    class="timeline-dot absolute left-0 top-3 w-4 h-4 rounded-full -translate-x-1/2 border-2 transition-all duration-500 shadow-lg bg-[var(--bg-primary)] border-[var(--glass-border)] group-hover:border-[var(--accent)] group-hover:bg-[var(--accent)] group-hover:shadow-[0_0_12px_var(--glow-color)]"
    data-card-index={index}
  >
    <div class="timeline-dot-inner absolute inset-0 rounded-full bg-[var(--accent)] opacity-0"></div>
  </div>
  
  <!-- Card Content -->
  <div class="glass-card p-8 ml-6 cursor-pointer group/card" data-expandable>
    <!-- Header -->
    <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
      <div class="flex-1 min-w-0">
        <h3 class="text-2xl font-bold text-[var(--text-primary)] group-hover/card:text-[var(--accent)] transition-colors duration-300 mb-2">
          {company}
        </h3>
        <p class="text-[var(--accent)] font-semibold text-lg">{jobTitle}</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-[var(--text-muted)] font-mono px-3 py-1.5 rounded-lg bg-[var(--glass-bg)] border border-[var(--glass-border)]">
        <span>{formattedStartDate}</span>
        <span class="text-[var(--accent)]">→</span>
        <span class:list={[isOngoing && 'text-[var(--accent)] font-semibold']}>{formattedEndDate}</span>
      </div>
    </div>
    
    <!-- Job Type -->
    <div class="mb-5">
      <span class="inline-block px-3 py-1.5 text-sm font-semibold text-[var(--accent)] bg-[var(--glass-bg)] border border-[var(--accent)]/30 rounded-lg">
        {job}
      </span>
    </div>
    
    <!-- Description -->
    <div class="job-description text-[var(--text-secondary)] text-base leading-relaxed tracking-tight line-clamp-3 transition-all duration-500">
      {jobDescription}
    </div>
    
    <!-- Expand Indicator -->
    <div class="expand-indicator mt-5 text-sm text-[var(--accent)] opacity-0 group-hover/card:opacity-100 transition-all duration-300 flex items-center gap-2 font-medium">
      <span>Click to expand</span>
      <span class="expand-arrow transition-transform duration-300 text-lg">↓</span>
    </div>
  </div>
</article>

<script>
  // Card expand/collapse functionality
  document.querySelectorAll('[data-expandable]').forEach((card) => {
    let expanded = false;
    const description = card.querySelector('.job-description');
    const arrow = card.querySelector('.expand-arrow') as HTMLElement | null;
    const indicator = card.querySelector('.expand-indicator span:first-child') as HTMLElement | null;
    
    card.addEventListener('click', () => {
      expanded = !expanded;
      if (description) {
        if (expanded) {
          description.classList.remove('line-clamp-3');
          if (arrow) arrow.style.transform = 'rotate(180deg)';
          if (indicator) indicator.textContent = 'Click to collapse';
        } else {
          description.classList.add('line-clamp-3');
          if (arrow) arrow.style.transform = 'rotate(0deg)';
          if (indicator) indicator.textContent = 'Click to expand';
        }
      }
    });
  });

  // Timeline dot active state based on scroll position
  // Only initialize once globally
  if (!(window as any).timelineScrollHandlerInitialized) {
    (window as any).timelineScrollHandlerInitialized = true;

    function updateActiveTimelineDot() {
      const cards = document.querySelectorAll('.career-card');
      if (cards.length === 0) return;

      const viewportCenter = window.innerHeight / 2;
      let closestCard: Element | null = null;
      let closestDistance = Infinity;

      // Find the card closest to viewport center
      cards.forEach((card) => {
        const rect = card.getBoundingClientRect();
        const cardCenter = rect.top + rect.height / 2;
        const distance = Math.abs(viewportCenter - cardCenter);

        if (distance < closestDistance) {
          closestDistance = distance;
          closestCard = card;
        }
      });

      // First, remove active class from ALL dots to ensure only one is active
      document.querySelectorAll('.timeline-dot').forEach((dot) => {
        dot.classList.remove('active');
        const inner = dot.querySelector('.timeline-dot-inner') as HTMLElement;
        if (inner) {
          inner.classList.remove('animate-ping');
          inner.style.opacity = '0';
        }
        // Reset dot appearance
        (dot as HTMLElement).style.borderColor = '';
        (dot as HTMLElement).style.backgroundColor = '';
        (dot as HTMLElement).style.boxShadow = '';
      });

      // Then, add active class to ONLY the closest card's dot
      if (closestCard) {
        const cardIndex = closestCard.getAttribute('data-card-index');
        if (cardIndex !== null) {
          const activeDot = document.querySelector(`.timeline-dot[data-card-index="${cardIndex}"]`);
          if (activeDot) {
            activeDot.classList.add('active');
            const inner = activeDot.querySelector('.timeline-dot-inner') as HTMLElement;
            if (inner) {
              inner.style.opacity = '0.75';
              inner.classList.add('animate-ping');
            }
          }
        }
      }
    }

    // Throttle scroll events for performance
    let scrollTimeout: number | null = null;
    window.addEventListener('scroll', () => {
      if (scrollTimeout !== null) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = window.setTimeout(() => {
        updateActiveTimelineDot();
      }, 50);
    });

    // Initial update after a short delay to ensure DOM is ready
    setTimeout(() => {
      updateActiveTimelineDot();
    }, 100);
  }
</script>
