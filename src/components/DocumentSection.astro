---
import fs from 'node:fs';
import path from 'node:path';
import { marked } from 'marked';

const {
  id,
  title,
  description,
  sourcePath,
  assetBase,
  downloadFileName,
  previewHeight = '750px',
  fallbackPdfUrl,
  isMarkdown = false,
} = Astro.props;

const docId = id ?? `doc-${(title?.toLowerCase() ?? 'document').replace(/[^a-z0-9]/g, '-')}`;

const resolveDocPath = (docPath) => {
  if (!docPath) return null;
  return path.resolve(docPath);
};

const scopeSelector = (selector, scope) => {
  if (!selector) return '';
  if (selector.startsWith('@')) return selector;
  if (selector.startsWith('html')) return selector.replace(/^html/, scope);
  if (selector.startsWith('body')) return selector.replace(/^body/, scope);
  return `${scope} ${selector}`;
};

const scopeCss = (css, scope) => {
  if (!css) return '';
  const importRules = [];
  const cleaned = css.replace(/@import[^;]+;/g, (match) => {
    importRules.push(match.trim());
    return '';
  });
  const scoped = cleaned.replace(/(^|})\s*([^{@}][^{]*)\{/g, (match, sep, selectors) => {
    const scopedSelectors = selectors
      .split(',')
      .map((selector) => scopeSelector(selector.trim(), scope))
      .filter(Boolean)
      .join(', ');
    return `${sep} ${scopedSelectors}{`;
  });
  return [...importRules, scoped].join('\n').trim();
};

let rawHtml = '';
let bodyHtml = '';
let bodyClass = '';
let css = '';
let missing = false;

const resolvedPath = resolveDocPath(sourcePath);

if (!resolvedPath) {
  missing = true;
} else {
  try {
    rawHtml = fs.readFileSync(resolvedPath, 'utf8');
  } catch (error) {
    missing = true;
  }
}

if (!missing && rawHtml) {
  if (isMarkdown || sourcePath?.endsWith('.md')) {
    // マークダウンファイルの場合
    bodyHtml = marked.parse(rawHtml);
    css = '';
  } else {
    // HTMLファイルの場合
    const styleMatch = rawHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
    if (styleMatch) {
      css = styleMatch[1].trim();
    }

    const bodyMatch = rawHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    bodyHtml = bodyMatch ? bodyMatch[1].trim() : rawHtml;

    const bodyClassMatch = rawHtml.match(/<body[^>]*class=["']([^"']+)["'][^>]*>/i);
    bodyClass = bodyClassMatch ? bodyClassMatch[1] : '';

    if (assetBase) {
      bodyHtml = bodyHtml.replace(/src=(["'])images\//g, (match, quote) => {
        return `src=${quote}${assetBase}images/`;
      });
    }

    // 日付を最新の日付に更新
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    
    // HTMLエンティティでエンコード
    const yearEntity = `&#${'年'.charCodeAt(0)};`;
    const monthEntity = `&#${'月'.charCodeAt(0)};`;
    const dayEntity = `&#${'日'.charCodeAt(0)};`;
    const nowEntity = `&#${'現'.charCodeAt(0)};&#${'在'.charCodeAt(0)};`;
    
    // 履歴書のパターン: 2025&#24180; &nbsp;3&#26376; 5&#26085;&#29694;&#22312;
    const datePattern1 = /\d{4}&#24180;\s*&nbsp;\s*\d{1,2}&#26376;\s*\d{1,2}&#26085;&#29694;&#22312;/g;
    bodyHtml = bodyHtml.replace(datePattern1, `${year}&#24180; &nbsp;${month}&#26376; ${day}&#26085;&#29694;&#22312;`);
    
    // 職務経歴書のパターン: 2024&#24180;8&#26376;24&#26085;&#29694;&#22312;
    const datePattern2 = /\d{4}&#24180;\d{1,2}&#26376;\d{1,2}&#26085;&#29694;&#22312;/g;
    bodyHtml = bodyHtml.replace(datePattern2, `${year}&#24180;${month}&#26376;${day}&#26085;&#29694;&#22312;`);
    
    // その他のパターン: 数字年 数字月 数字日現在（HTMLエンティティなし）
    const datePattern3 = /\d{4}年\s*\d{1,2}月\s*\d{1,2}日現在/g;
    bodyHtml = bodyHtml.replace(datePattern3, `${year}年 ${month}月 ${day}日現在`);
  }
}

const scopedCss = css ? scopeCss(css, `#${docId}`) : '';
---

<section class="glass-card p-8 md:p-10 animate-fade-in" style="width: 100%; max-width: 100%;">
  <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
    <div>
      <h2 class="section-title mb-1">{title}</h2>
      {description && <p class="text-[var(--text-muted)] text-sm">{description}</p>}
    </div>
    {!missing && (
      <button
        type="button"
        data-doc-download
        data-doc-id={docId}
        data-doc-filename={downloadFileName}
        class="doc-download-btn"
      >
        <span>↓</span>
        <span>Download PDF</span>
      </button>
    )}
    {missing && fallbackPdfUrl && (
      <a
        href={fallbackPdfUrl}
        download
        class="doc-download-btn"
      >
        <span>↓</span>
        <span>Download PDF</span>
      </a>
    )}
  </div>

  {!missing ? (
    <>
      {scopedCss && (
        <style set:html={scopedCss}></style>
      )}
      {isMarkdown && (
        <style is:global>
          .doc-viewer.markdown-content h1,
          .doc-viewer.markdown-content h2,
          .doc-viewer.markdown-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
          }
          .doc-viewer.markdown-content h1 {
            font-size: 2rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
          }
          .doc-viewer.markdown-content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3rem;
          }
          .doc-viewer.markdown-content h3 {
            font-size: 1.25rem;
          }
          .doc-viewer.markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
          }
          .doc-viewer.markdown-content ul,
          .doc-viewer.markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
          }
          .doc-viewer.markdown-content li {
            margin-bottom: 0.5rem;
          }
          .doc-viewer.markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
          }
          .doc-viewer.markdown-content table th,
          .doc-viewer.markdown-content table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
          }
          .doc-viewer.markdown-content table th {
            background-color: #f9fafb;
            font-weight: 600;
          }
          .doc-viewer.markdown-content hr {
            margin: 2rem 0;
            border: none;
            border-top: 1px solid #e5e7eb;
          }
          .doc-viewer.markdown-content code {
            background-color: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
          }
          .doc-viewer.markdown-content pre {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
          }
          .doc-viewer.markdown-content pre code {
            background-color: transparent;
            padding: 0;
          }
          .doc-viewer.markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
          }
          .doc-viewer.markdown-content a:hover {
            color: #2563eb;
          }
          .doc-viewer.markdown-content strong {
            font-weight: 600;
          }
        </style>
      )}
      <div id={docId} class={`doc-viewer ${isMarkdown ? 'markdown-content' : ''}`} style={`max-height: ${previewHeight}; width: 100%; max-width: 100%;`} set:html={bodyHtml}></div>
    </>
  ) : fallbackPdfUrl ? (
    <div class="rounded-xl overflow-hidden border border-[var(--glass-border)]">
      <embed
        src={fallbackPdfUrl}
        type="application/pdf"
        class="w-full h-[600px] md:h-[750px]"
      />
    </div>
  ) : (
    <div class="rounded-xl border border-[var(--glass-border)] p-6 text-[var(--text-muted)]">
      <p>HTML source not found. Add the file at <code>{sourcePath}</code> to enable dynamic rendering.</p>
    </div>
  )}
</section>

<style is:global>
  .doc-viewer {
    background: #ffffff;
    color: #000000;
    border-radius: 16px;
    border: 1px solid var(--glass-border);
    overflow-y: auto;
    overflow-x: hidden;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 1rem;
    margin: 0 auto;
  }

  .doc-viewer--pdf {
    border: none;
    border-radius: 0;
    max-height: none;
    overflow: visible;
    width: 210mm;
    max-width: none;
    padding: 0;
  }

  /* 固定幅を上書きして右側の余白をなくす - 最優先 */
  .doc-viewer:not(.doc-viewer--pdf) > * {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
  }

  /* すべての要素の幅を強制的に制限 */
  .doc-viewer:not(.doc-viewer--pdf) * {
    max-width: 100% !important;
    box-sizing: border-box !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
  }
  
  /* インラインスタイルで指定された幅を完全に上書き */
  .doc-viewer:not(.doc-viewer--pdf) [style*="width"],
  .doc-viewer:not(.doc-viewer--pdf) [style*="max-width"],
  .doc-viewer:not(.doc-viewer--pdf) [style*="min-width"] {
    max-width: 100% !important;
    min-width: 0 !important;
    width: auto !important;
  }

  /* bodyやhtml要素の幅も上書き */
  .doc-viewer:not(.doc-viewer--pdf) body,
  .doc-viewer:not(.doc-viewer--pdf) html {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
  }

  /* PDF生成時にテキストが切れないように */
  .doc-viewer:not(.doc-viewer--pdf) p,
  .doc-viewer:not(.doc-viewer--pdf) span,
  .doc-viewer:not(.doc-viewer--pdf) div,
  .doc-viewer:not(.doc-viewer--pdf) td,
  .doc-viewer:not(.doc-viewer--pdf) th,
  .doc-viewer:not(.doc-viewer--pdf) li {
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    hyphens: auto;
    max-width: 100% !important;
    width: auto !important;
  }

  /* テーブルセルも幅を制限 */
  .doc-viewer:not(.doc-viewer--pdf) table td,
  .doc-viewer:not(.doc-viewer--pdf) table th {
    max-width: 100% !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
  }
  
  /* 絶対位置指定の要素も調整 */
  .doc-viewer:not(.doc-viewer--pdf) [style*="position: absolute"],
  .doc-viewer:not(.doc-viewer--pdf) [style*="position:fixed"] {
    max-width: 100% !important;
  }

  .doc-viewer img {
    max-width: 100%;
    height: auto;
    display: block;
  }

  .doc-viewer:not(.doc-viewer--pdf) table {
    width: 100% !important;
    max-width: 100% !important;
    table-layout: auto;
    word-wrap: break-word;
    overflow-wrap: break-word;
    display: table;
    margin: 0;
  }

  .doc-viewer:not(.doc-viewer--pdf) table td,
  .doc-viewer:not(.doc-viewer--pdf) table th {
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
  }

  @media (max-width: 768px) {
    .doc-viewer {
      padding: 0.75rem;
      font-size: 0.875rem;
    }

    .doc-viewer table {
      font-size: 0.75rem;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  }

  .doc-download-btn {
    color: #ffffff !important;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(to right, var(--accent), var(--accent-dim));
    border-radius: 0.75rem;
    font-weight: 600;
    box-shadow: 0 10px 15px -3px var(--glow-color);
    transition: all 0.3s;
  }

  .doc-download-btn:hover {
    box-shadow: 0 20px 25px -5px var(--glow-color);
    transform: scale(1.05);
  }
</style>
